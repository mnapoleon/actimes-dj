{% extends 'laptimes/base.html' %}

{% block content %}
<!-- Session count info and controls -->
<div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
    <h2 class="mb-0">
        Sessions 
        {% if paginator %}
            <small class="text-muted">({{ paginator.count }} total)</small>
        {% endif %}
    </h2>
    
    <div class="d-flex align-items-center gap-3 flex-wrap">
        <!-- Per page selector -->
        <div class="d-flex align-items-center">
            <label for="perPageSelect" class="form-label me-2 mb-0 text-nowrap">Show:</label>
            <select id="perPageSelect" class="form-select form-select-sm" style="width: auto;">
                {% for option in per_page_options %}
                    <option value="{{ option }}" {% if option == current_per_page %}selected{% endif %}>
                        {{ option }}
                    </option>
                {% endfor %}
            </select>
            <span class="text-muted ms-2 text-nowrap">per page</span>
        </div>
        
        <!-- Current page info -->
        {% if is_paginated %}
            <small class="text-muted text-nowrap">
                Showing {{ page_obj.start_index }}-{{ page_obj.end_index }} of {{ paginator.count }}
            </small>
        {% endif %}
    </div>
</div>

{% if sessions %}
  <div class="table-responsive mb-4">
    <table class="table table-striped align-middle">
      <thead>
        <tr>
          <th>Name</th>
          <th>Track</th>
          <th>Car</th>
          <th>Fastest Lap</th>
          <th>Driver</th>
          <th>Laps</th>
          <th>Upload Date</th>
          <th class="text-end">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for session in sessions %}
          {% with fastest=session.get_fastest_lap %}
          <tr>
            <td>
              <a href="{% url 'session_detail' session.pk %}" class="fw-semibold text-decoration-none">
                {% if session.session_name %}{{ session.session_name }}{% else %}{{ session.track }}{% endif %}
              </a>
            </td>
            <td>{{ session.track }}</td>
            <td>{{ session.car }}</td>
            <td>
              {% if fastest %}
                <span class="text-success"><i class="bi bi-stopwatch"></i> {{ fastest.format_time }}</span>
              {% else %}
                <span class="text-muted">—</span>
              {% endif %}
            </td>
            <td>
              {% if fastest %}
                {{ fastest.driver_name }}
              {% else %}
                <span class="text-muted">—</span>
              {% endif %}
            </td>
            <td>{{ session.lap_count }}</td>
            <td>
              <small class="text-muted">{{ session.upload_date|date:"M j, Y" }}</small>
              <br>
              <small class="text-muted">{{ session.upload_date|time:"g:i A" }}</small>
            </td>
            <td class="text-end">
              <div class="btn-group btn-group-sm">
                <a href="{% url 'session_detail' session.pk %}" class="btn btn-outline-primary btn-sm" title="View">
                  <i class="bi bi-eye"></i>
                </a>
                <a href="{% url 'session_edit' session.pk %}" class="btn btn-outline-secondary btn-sm" title="Edit">
                  <i class="bi bi-pencil-square"></i>
                </a>
                <a href="{% url 'session_delete' session.pk %}" class="btn btn-outline-danger btn-sm" title="Delete">
                  <i class="bi bi-trash3"></i>
                </a>
              </div>
            </td>
          </tr>
          {% endwith %}
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Pagination controls -->
  {% if is_paginated %}
  <nav aria-label="Session pagination" class="mb-4">
    <ul class="pagination justify-content-center">
      <!-- First page -->
      {% if page_obj.has_previous %}
        <li class="page-item">
          <a class="page-link" href="?page=1&per_page={{ current_per_page }}" aria-label="First">
            <span aria-hidden="true">&laquo;&laquo;</span>
          </a>
        </li>
      {% endif %}
      
      <!-- Previous page -->
      {% if page_obj.has_previous %}
        <li class="page-item">
          <a class="page-link" href="?page={{ page_obj.previous_page_number }}&per_page={{ current_per_page }}" aria-label="Previous">
            <span aria-hidden="true">&laquo;</span>
          </a>
        </li>
      {% else %}
        <li class="page-item disabled">
          <span class="page-link" aria-hidden="true">&laquo;</span>
        </li>
      {% endif %}

      <!-- Page numbers -->
      {% for num in paginator.page_range %}
        {% if page_obj.number == num %}
          <li class="page-item active" aria-current="page">
            <span class="page-link">{{ num }}</span>
          </li>
        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
          <li class="page-item">
            <a class="page-link" href="?page={{ num }}&per_page={{ current_per_page }}">{{ num }}</a>
          </li>
        {% endif %}
      {% endfor %}

      <!-- Next page -->
      {% if page_obj.has_next %}
        <li class="page-item">
          <a class="page-link" href="?page={{ page_obj.next_page_number }}&per_page={{ current_per_page }}" aria-label="Next">
            <span aria-hidden="true">&raquo;</span>
          </a>
        </li>
      {% else %}
        <li class="page-item disabled">
          <span class="page-link" aria-hidden="true">&raquo;</span>
        </li>
      {% endif %}

      <!-- Last page -->
      {% if page_obj.has_next %}
        <li class="page-item">
          <a class="page-link" href="?page={{ paginator.num_pages }}&per_page={{ current_per_page }}" aria-label="Last">
            <span aria-hidden="true">&raquo;&raquo;</span>
          </a>
        </li>
      {% endif %}
    </ul>
  </nav>
  {% endif %}

{% else %}
  <p class="text-muted">No sessions uploaded yet.</p>
{% endif %}

<div class="card mb-4">
  <div class="card-body">
    <h2 class="card-title">Upload Race Data</h2>
    <form method="post" enctype="multipart/form-data">
      {% csrf_token %}
      <div class="mb-3">
        {{ form.json_file.label_tag }} 
        {{ form.json_file }}
        {% if form.json_file.help_text %}
          <div class="form-text">{{ form.json_file.help_text }}</div>
        {% endif %}
        {% if form.json_file.errors %}
          {% for error in form.json_file.errors %}
            {% if 'already been uploaded' in error %}
              <!-- Enhanced duplicate file error container -->
              <div class="alert alert-danger mt-3 border-start border-danger border-4" role="alert">
                <div class="d-flex align-items-center mb-2">
                  <i class="bi bi-exclamation-triangle-fill text-danger me-2" style="font-size: 1.25rem;"></i>
                  <strong>Duplicate File Detected</strong>
                </div>
                <div class="ms-4">
                  {{ error|safe }}
                </div>
              </div>
            {% else %}
              <!-- Standard error display -->
              <div class="text-danger mt-2">
                <i class="bi bi-exclamation-circle me-1"></i>{{ error }}
              </div>
            {% endif %}
          {% endfor %}
        {% endif %}
      </div>
      <button type="submit" class="btn btn-primary">
        <i class="bi bi-upload"></i> Upload Session
      </button>
    </form>
  </div>
</div>

<script>
// Handle per-page selector change
document.getElementById('perPageSelect').addEventListener('change', function() {
    const perPage = this.value;
    const url = new URL(window.location);
    url.searchParams.set('per_page', perPage);
    url.searchParams.delete('page'); // Reset to page 1 when changing per_page
    window.location.href = url.toString();
});
</script>
{% endblock %}