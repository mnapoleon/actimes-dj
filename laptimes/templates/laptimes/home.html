{% extends 'laptimes/base.html' %}

{% block content %}
<!-- Session count info and controls -->
<div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
    <h2 class="mb-0">
        Sessions 
        {% if paginator %}
            <small class="text-muted">({{ paginator.count }} total)</small>
        {% endif %}
    </h2>
    
    <div class="d-flex align-items-center gap-3 flex-wrap">
        <!-- Per page selector -->
        <div class="d-flex align-items-center">
            <label for="perPageSelect" class="form-label me-2 mb-0 text-nowrap">Show:</label>
            <select id="perPageSelect" class="form-select form-select-sm" style="width: auto;">
                {% for option in per_page_options %}
                    <option value="{{ option }}" {% if option == current_per_page %}selected{% endif %}>
                        {{ option }}
                    </option>
                {% endfor %}
            </select>
            <span class="text-muted ms-2 text-nowrap">per page</span>
        </div>
        
        <!-- Current page info -->
        {% if is_paginated %}
            <small class="text-muted text-nowrap">
                Showing {{ page_obj.start_index }}-{{ page_obj.end_index }} of {{ paginator.count }}
            </small>
        {% endif %}
    </div>
</div>

<!-- Advanced Filter Form -->
<div class="card mb-4">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h6 class="mb-0">
                <i class="bi bi-funnel"></i> Filter Sessions
                {% if active_filter_count > 0 %}
                    <span class="badge bg-primary ms-2">{{ active_filter_count }}</span>
                {% endif %}
            </h6>
            <div>
                <button type="button" class="btn btn-sm btn-outline-secondary" id="clearFilters">
                    <i class="bi bi-x-circle"></i> Clear All
                </button>
                <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="collapse" data-bs-target="#filterCollapse" aria-expanded="false" aria-controls="filterCollapse">
                    <i class="bi bi-chevron-down" id="filterToggleIcon"></i>
                </button>
            </div>
        </div>
    </div>
    
    <div class="collapse {% if active_filter_count > 0 %}show{% endif %}" id="filterCollapse">
        <div class="card-body">
            <form method="get" id="filterForm">
                <div class="row g-3">
                    <!-- Search -->
                    <div class="col-md-6">
                        <label for="searchInput" class="form-label">Search</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-search"></i></span>
                            <input type="text" name="search" id="searchInput" class="form-control" 
                                   placeholder="Search sessions, tracks, cars, drivers..." 
                                   value="{{ current_filters.search }}">
                        </div>
                    </div>
                    
                    <!-- Track Filter -->
                    <div class="col-md-3">
                        <label for="trackSelect" class="form-label">Track</label>
                        <select name="track" id="trackSelect" class="form-select">
                            <option value="all" {% if current_filters.track == 'all' %}selected{% endif %}>All Tracks</option>
                            {% for track in tracks %}
                                <option value="{{ track }}" {% if track == current_filters.track %}selected{% endif %}>
                                    {{ track }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Car Filter -->
                    <div class="col-md-3">
                        <label for="carSelect" class="form-label">Car</label>
                        <select name="car" id="carSelect" class="form-select">
                            <option value="all" {% if current_filters.car == 'all' %}selected{% endif %}>All Cars</option>
                            {% for car in cars %}
                                <option value="{{ car }}" {% if car == current_filters.car %}selected{% endif %}>
                                    {{ car }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Session Type Filter -->
                    <div class="col-md-3">
                        <label for="sessionTypeSelect" class="form-label">Session Type</label>
                        <select name="session_type" id="sessionTypeSelect" class="form-select">
                            <option value="all" {% if current_filters.session_type == 'all' %}selected{% endif %}>All Types</option>
                            {% for type in session_types %}
                                <option value="{{ type }}" {% if type == current_filters.session_type %}selected{% endif %}>
                                    {{ type }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Date Range -->
                    <div class="col-md-4">
                        <label for="dateFrom" class="form-label">From Date</label>
                        <input type="date" name="date_from" id="dateFrom" class="form-control" 
                               value="{{ current_filters.date_from }}">
                    </div>
                    
                    <div class="col-md-4">
                        <label for="dateTo" class="form-label">To Date</label>
                        <input type="date" name="date_to" id="dateTo" class="form-control" 
                               value="{{ current_filters.date_to }}">
                    </div>
                    
                    <!-- Sort Options -->
                    <div class="col-md-4">
                        <label for="sortSelect" class="form-label">Sort By</label>
                        <select name="sort" id="sortSelect" class="form-select">
                            <option value="-upload_date" {% if current_filters.sort == '-upload_date' %}selected{% endif %}>Newest First</option>
                            <option value="upload_date" {% if current_filters.sort == 'upload_date' %}selected{% endif %}>Oldest First</option>
                            <option value="track" {% if current_filters.sort == 'track' %}selected{% endif %}>Track (A-Z)</option>
                            <option value="-track" {% if current_filters.sort == '-track' %}selected{% endif %}>Track (Z-A)</option>
                            <option value="car" {% if current_filters.sort == 'car' %}selected{% endif %}>Car (A-Z)</option>
                            <option value="-car" {% if current_filters.sort == '-car' %}selected{% endif %}>Car (Z-A)</option>
                            <option value="-lap_count" {% if current_filters.sort == '-lap_count' %}selected{% endif %}>Most Laps</option>
                            <option value="lap_count" {% if current_filters.sort == 'lap_count' %}selected{% endif %}>Fewest Laps</option>
                            <option value="session_type" {% if current_filters.sort == 'session_type' %}selected{% endif %}>Session Type (A-Z)</option>
                            <option value="-session_type" {% if current_filters.sort == '-session_type' %}selected{% endif %}>Session Type (Z-A)</option>
                        </select>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-search"></i> Apply Filters
                        </button>
                        <button type="button" class="btn btn-outline-secondary" id="resetFilters">
                            <i class="bi bi-arrow-clockwise"></i> Reset
                        </button>
                        {% if active_filter_count > 0 %}
                            <small class="text-muted ms-3">
                                <i class="bi bi-info-circle"></i> {{ active_filter_count }} filter{{ active_filter_count|pluralize }} active
                            </small>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Hidden field to preserve per_page -->
                <input type="hidden" name="per_page" value="{{ current_per_page }}">
            </form>
        </div>
    </div>
</div>

{% if sessions %}
  <div class="table-responsive mb-4">
    <table class="table table-striped align-middle">
      <thead>
        <tr>
          <th>Name</th>
          <th>Track</th>
          <th>Car</th>
          <th>Session Type</th>
          <th>Fastest Lap</th>
          <th>Upload Date</th>
          <th class="text-end">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for session in sessions %}
          {% with fastest=session.get_fastest_lap %}
          <tr>
            <td>
              <a href="{% url 'session_detail' session.pk %}" class="fw-semibold text-decoration-none">
                {% if session.session_name %}{{ session.session_name }}{% else %}{{ session.track }}{% endif %}
              </a>
            </td>
            <td>{{ session.track }}</td>
            <td>{{ session.car }}</td>
            <td>{{ session.session_type|default:"—" }}</td>
            <td>
              {% if fastest %}
                <span class="text-success"><i class="bi bi-stopwatch"></i> {{ fastest.format_time }}</span>
              {% else %}
                <span class="text-muted">—</span>
              {% endif %}
            </td>
            <td>
              <small class="text-muted">{{ session.upload_date|date:"M j, Y" }}</small>
              <br>
              <small class="text-muted">{{ session.upload_date|time:"g:i A" }}</small>
            </td>
            <td class="text-end">
              <div class="btn-group btn-group-sm">
                <a href="{% url 'session_detail' session.pk %}" class="btn btn-outline-primary btn-sm" title="View">
                  <i class="bi bi-eye"></i>
                </a>
                <a href="{% url 'session_edit' session.pk %}" class="btn btn-outline-secondary btn-sm" title="Edit">
                  <i class="bi bi-pencil-square"></i>
                </a>
                <a href="{% url 'session_delete' session.pk %}" class="btn btn-outline-danger btn-sm" title="Delete">
                  <i class="bi bi-trash3"></i>
                </a>
              </div>
            </td>
          </tr>
          {% endwith %}
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Pagination controls -->
  {% if is_paginated %}
  <nav aria-label="Session pagination" class="mb-4">
    <ul class="pagination justify-content-center">
      <!-- First page -->
      {% if page_obj.has_previous %}
        <li class="page-item">
          <a class="page-link pagination-link" href="?page=1" data-page="1" aria-label="First">
            <span aria-hidden="true">&laquo;&laquo;</span>
          </a>
        </li>
      {% endif %}
      
      <!-- Previous page -->
      {% if page_obj.has_previous %}
        <li class="page-item">
          <a class="page-link pagination-link" href="?page={{ page_obj.previous_page_number }}" data-page="{{ page_obj.previous_page_number }}" aria-label="Previous">
            <span aria-hidden="true">&laquo;</span>
          </a>
        </li>
      {% else %}
        <li class="page-item disabled">
          <span class="page-link" aria-hidden="true">&laquo;</span>
        </li>
      {% endif %}

      <!-- Page numbers -->
      {% for num in paginator.page_range %}
        {% if page_obj.number == num %}
          <li class="page-item active" aria-current="page">
            <span class="page-link">{{ num }}</span>
          </li>
        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
          <li class="page-item">
            <a class="page-link pagination-link" href="?page={{ num }}" data-page="{{ num }}">{{ num }}</a>
          </li>
        {% endif %}
      {% endfor %}

      <!-- Next page -->
      {% if page_obj.has_next %}
        <li class="page-item">
          <a class="page-link pagination-link" href="?page={{ page_obj.next_page_number }}" data-page="{{ page_obj.next_page_number }}" aria-label="Next">
            <span aria-hidden="true">&raquo;</span>
          </a>
        </li>
      {% else %}
        <li class="page-item disabled">
          <span class="page-link" aria-hidden="true">&raquo;</span>
        </li>
      {% endif %}

      <!-- Last page -->
      {% if page_obj.has_next %}
        <li class="page-item">
          <a class="page-link pagination-link" href="?page={{ paginator.num_pages }}" data-page="{{ paginator.num_pages }}" aria-label="Last">
            <span aria-hidden="true">&raquo;&raquo;</span>
          </a>
        </li>
      {% endif %}
    </ul>
  </nav>
  {% endif %}

{% else %}
  <p class="text-muted">No sessions uploaded yet.</p>
{% endif %}

<div class="card mb-4">
  <div class="card-body">
    <h2 class="card-title">Upload Race Data</h2>
    <form method="post" enctype="multipart/form-data" id="uploadForm">
      {% csrf_token %}
      
      <!-- Upload Type Selection -->
      <div class="mb-3">
        <label class="form-label">Upload Method</label>
        <div class="d-flex gap-3">
          {% for choice in form.upload_type %}
            <div class="form-check">
              {{ choice.tag }}
              <label class="form-check-label" for="{{ choice.id_for_label }}">
                {{ choice.choice_label }}
              </label>
            </div>
          {% endfor %}
        </div>
        {% if form.upload_type.help_text %}
          <div class="form-text">{{ form.upload_type.help_text }}</div>
        {% endif %}
      </div>
      
      <!-- File Upload Field -->
      <div class="mb-3">
        {{ form.json_files.label_tag }}
        {{ form.json_files }}
        {% if form.json_files.help_text %}
          <div class="form-text" id="uploadHelpText">{{ form.json_files.help_text }}</div>
        {% endif %}
        
        <!-- Display selected files/directory info -->
        <div id="fileInfo" class="mt-2 text-muted" style="display: none;">
          <small id="fileInfoText"></small>
        </div>
        
        <!-- Handle form errors -->
        {% if form.json_files.errors %}
          {% for error in form.json_files.errors %}
            {% if 'Already uploaded' in error %}
              <!-- Enhanced duplicate file error container -->
              <div class="alert alert-danger mt-3 border-start border-danger border-4" role="alert">
                <div class="d-flex align-items-center mb-2">
                  <i class="bi bi-exclamation-triangle-fill text-danger me-2" style="font-size: 1.25rem;"></i>
                  <strong>Duplicate File Detected</strong>
                </div>
                <div class="ms-4">
                  {{ error|safe }}
                </div>
              </div>
            {% else %}
              <!-- Standard error display -->
              <div class="text-danger mt-2">
                <i class="bi bi-exclamation-circle me-1"></i>{{ error|safe }}
              </div>
            {% endif %}
          {% endfor %}
        {% endif %}
        
        {% if form.upload_type.errors %}
          {% for error in form.upload_type.errors %}
            <div class="text-danger mt-2">
              <i class="bi bi-exclamation-circle me-1"></i>{{ error }}
            </div>
          {% endfor %}
        {% endif %}
        
        {% if form.non_field_errors %}
          {% for error in form.non_field_errors %}
            <div class="text-danger mt-2">
              <i class="bi bi-exclamation-circle me-1"></i>{{ error }}
            </div>
          {% endfor %}
        {% endif %}
      </div>
      
      <button type="submit" class="btn btn-primary" id="uploadButton">
        <i class="bi bi-upload"></i> <span id="uploadButtonText">Upload Sessions</span>
      </button>
    </form>
  </div>
</div>

<script>
// Upload form functionality
document.addEventListener('DOMContentLoaded', function() {
    const uploadTypeRadios = document.querySelectorAll('input[name="upload_type"]');
    const fileInput = document.getElementById('id_json_files');
    const fileInfo = document.getElementById('fileInfo');
    const fileInfoText = document.getElementById('fileInfoText');
    const uploadHelpText = document.getElementById('uploadHelpText');
    const uploadButtonText = document.getElementById('uploadButtonText');

    function updateFileInputAttributes() {
        const selectedType = document.querySelector('input[name="upload_type"]:checked').value;
        
        if (selectedType === 'directory') {
            fileInput.setAttribute('webkitdirectory', '');
            fileInput.removeAttribute('multiple');
            uploadHelpText.textContent = 'Select a directory containing JSON files with race session data';
            uploadButtonText.textContent = 'Upload Directory';
        } else {
            fileInput.removeAttribute('webkitdirectory');
            fileInput.setAttribute('multiple', '');
            uploadHelpText.textContent = 'Upload JSON files containing race session data (supports multiple files or directories)';
            uploadButtonText.textContent = 'Upload Files';
        }
        
        // Clear the file input when switching types
        fileInput.value = '';
        fileInfo.style.display = 'none';
    }

    function updateFileInfo() {
        const files = fileInput.files;
        if (files.length > 0) {
            const selectedType = document.querySelector('input[name="upload_type"]:checked').value;
            
            if (selectedType === 'directory') {
                // For directory uploads, show directory name and file count
                const firstFile = files[0];
                const directoryPath = firstFile.webkitRelativePath;
                const directoryName = directoryPath.split('/')[0];
                const jsonFiles = Array.from(files).filter(file => file.name.endsWith('.json'));
                
                fileInfoText.innerHTML = `
                    <i class="bi bi-folder2-open"></i> 
                    Directory: <strong>${directoryName}</strong><br>
                    <i class="bi bi-file-earmark-text"></i> 
                    Found ${jsonFiles.length} JSON file${jsonFiles.length !== 1 ? 's' : ''}
                `;
            } else {
                // For file uploads, show file names
                const jsonFiles = Array.from(files).filter(file => file.name.endsWith('.json'));
                
                if (files.length === 1) {
                    fileInfoText.innerHTML = `
                        <i class="bi bi-file-earmark-text"></i> 
                        Selected: <strong>${files[0].name}</strong>
                    `;
                } else {
                    fileInfoText.innerHTML = `
                        <i class="bi bi-files"></i> 
                        Selected ${jsonFiles.length} JSON file${jsonFiles.length !== 1 ? 's' : ''} out of ${files.length} total file${files.length !== 1 ? 's' : ''}
                    `;
                }
            }
            
            fileInfo.style.display = 'block';
        } else {
            fileInfo.style.display = 'none';
        }
    }

    // Initialize on page load
    updateFileInputAttributes();

    // Handle upload type changes
    uploadTypeRadios.forEach(radio => {
        radio.addEventListener('change', updateFileInputAttributes);
    });

    // Handle file selection changes
    fileInput.addEventListener('change', updateFileInfo);
});

// Handle per-page selector change
document.getElementById('perPageSelect').addEventListener('change', function() {
    const perPage = this.value;
    const url = new URL(window.location);
    url.searchParams.set('per_page', perPage);
    url.searchParams.delete('page'); // Reset to page 1 when changing per_page
    window.location.href = url.toString();
});

// Filter form functionality
document.addEventListener('DOMContentLoaded', function() {
    const filterForm = document.getElementById('filterForm');
    const searchInput = document.getElementById('searchInput');
    const clearFiltersBtn = document.getElementById('clearFilters');
    const resetFiltersBtn = document.getElementById('resetFilters');
    const filterToggleIcon = document.getElementById('filterToggleIcon');
    const filterCollapse = document.getElementById('filterCollapse');
    
    let searchTimeout;
    
    // Auto-submit filters with debouncing for search
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                submitFilterForm();
            }, 500); // 500ms delay for search
        });
    }
    
    // Auto-submit on dropdown changes
    const selects = filterForm.querySelectorAll('select');
    selects.forEach(select => {
        select.addEventListener('change', function() {
            submitFilterForm();
        });
    });
    
    // Auto-submit on date changes
    const dateInputs = filterForm.querySelectorAll('input[type="date"]');
    dateInputs.forEach(input => {
        input.addEventListener('change', function() {
            submitFilterForm();
        });
    });
    
    // Submit filter form
    function submitFilterForm() {
        // Remove page parameter when applying filters
        const pageInput = filterForm.querySelector('input[name="page"]');
        if (pageInput) {
            pageInput.remove();
        }
        filterForm.submit();
    }
    
    // Clear all filters
    if (clearFiltersBtn) {
        clearFiltersBtn.addEventListener('click', function() {
            // Clear URL parameters except per_page
            const url = new URL(window.location);
            const perPage = url.searchParams.get('per_page');
            url.search = '';
            if (perPage) url.searchParams.set('per_page', perPage);
            window.location.href = url.toString();
        });
    }
    
    // Reset filters to defaults
    if (resetFiltersBtn) {
        resetFiltersBtn.addEventListener('click', function() {
            filterForm.reset();
            submitFilterForm();
        });
    }
    
    // Update pagination links to preserve filters
    function updatePaginationLinks() {
        const formData = new FormData(filterForm);
        const params = new URLSearchParams();
        
        // Add all form data except page
        for (const [key, value] of formData.entries()) {
            if (key !== 'page' && value && value !== 'all') {
                params.set(key, value);
            }
        }
        
        // Update all pagination links
        document.querySelectorAll('.pagination-link').forEach(link => {
            const url = new URL(link.href, window.location.origin);
            const page = link.dataset.page;
            
            // Clear existing params except page
            const newUrl = new URL(window.location.origin + window.location.pathname);
            newUrl.searchParams.set('page', page);
            
            // Add filter params
            for (const [key, value] of params.entries()) {
                newUrl.searchParams.set(key, value);
            }
            
            link.href = newUrl.toString();
        });
    }
    
    // Update pagination links on page load
    updatePaginationLinks();
    
    // Handle filter collapse toggle icon
    if (filterCollapse) {
        filterCollapse.addEventListener('shown.bs.collapse', function() {
            filterToggleIcon.className = 'bi bi-chevron-up';
        });
        
        filterCollapse.addEventListener('hidden.bs.collapse', function() {
            filterToggleIcon.className = 'bi bi-chevron-down';
        });
    }
    
    // Set initial icon state
    if (filterCollapse && filterCollapse.classList.contains('show')) {
        filterToggleIcon.className = 'bi bi-chevron-up';
    }
});
</script>
{% endblock %}